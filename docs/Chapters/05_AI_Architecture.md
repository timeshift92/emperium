# ‚öôÔ∏è 05. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ AI-—Å–∏–º—É–ª—è—Ü–∏–∏

## üß± –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫
- .NET 9 (Minimal API), C# 13  
- EF Core + SQLite  
- Aspire-—Å—Ç–∏–ª—å: Api / Domain / Infrastructure / Llm / AppHost

## üîÅ Tick-Loop (–ø–æ—Ä—è–¥–æ–∫ —Ñ–∞–∑)
1) TimeAI ‚Üí 2) WorldAI ‚Üí 3) SeasonAI ‚Üí 4) NatureAI ‚Üí 5) EconomyAI ‚Üí  
6) Empire/Politics/Conflict ‚Üí 7) Ownership/Property ‚Üí  
8) Genetic/Talent/Trait/Skill/Perception ‚Üí 9) Relationship/Family/Society ‚Üí  
10) Knowledge/Innovation/Diffusion/Scholar ‚Üí 11) Faith/Mythos/Philosophy/Zeitgeist ‚Üí  
12) Culture/History/DeepHistory ‚Üí 13) Npc/Inner/Moral/Social/Reputation ‚Üí 14) EventDispatcher

## üß© –ö–æ–Ω—Ç—Ä–∞–∫—Ç –∞–≥–µ–Ω—Ç–∞
```csharp
public interface IWorldAgent
{
    string Name { get; }
    Task TickAsync(AppDb db, ILlmClient llm, CancellationToken ct);
}
```

## üì¶ –ö–ª—é—á–µ–≤—ã–µ –º–æ–¥–µ–ª–∏
WorldTime, SeasonState, WeatherSnapshot, Location, Faction, Army, Character, Family, Relationship,  
NpcEssence, TalentDevelopment, Ownership, NpcMemory, EconomySnapshot, Technology, KnowledgeWave, RegionalKnowledge,  
Rumor, Deity, Building, WorldChronicle, GameEvent.

## ü§ñ LLM-–ø—Ä–æ–º–ø—Ç—ã (—Ç–æ–ª—å–∫–æ JSON)
- WeatherSnapshot ‚Üí `{ condition, temperatureC, windKph, precipitationMm, dayLength }`  
- NpcReply ‚Üí `{ reply, moodDelta?, loyaltyDelta? }`  
- KnowledgeDiscovery ‚Üí `{ name, field, effect, impact }`  
- MythosEffect ‚Üí `{ omen, crowdEffect, duration }`  
- Dream ‚Üí `{ symbol, meaning, action }`  
- HistorySummary ‚Üí `{ summary, highlights[] }`  
- LegalDecision ‚Üí `{ verdict, penalty, precedentNote }`


## ‚öôÔ∏è –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –º–æ–¥–µ–ª–µ–π Imperium

–ù–∏–∂–µ –ø–æ–∫–∞–∑–∞–Ω–æ, –∫–∞–∫ —Ä–∞–∑–Ω—ã–µ LLM-–º–æ–¥–µ–ª–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É—é—Ç –≤–Ω—É—Ç—Ä–∏ —Å–∏–º—É–ª—è—Ü–∏–∏ Imperium.

![–°—Ö–µ–º–∞ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π Imperium](./A_flowchart_diagram_in_SVG_format_illustrates_the_.png)

> –ö–∞–∂–¥—ã–π —Å–ª–æ–π –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—É—é –º–æ–¥–µ–ª—å Ollama –∏–ª–∏ OpenAI:
> - WorldAI / SeasonAI ‚Äî `mistral`
> - EconomyAI / ConflictAI ‚Äî `llama3:8b`
> - CouncilAI / CultureAI ‚Äî `gemma2:9b`
> - NpcAI ‚Äî `phi3:medium`

## üîî EventDispatcher –∏ —Ñ–æ–Ω–æ–≤—ã–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏

–í–≤–µ–¥—ë–Ω `EventDispatcher` ‚Äî —Ñ–æ–Ω–æ–≤–æ–π —Å–µ—Ä–≤–∏—Å —Å –æ—á–µ—Ä–µ–¥—å—é, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç `GameEvent` –æ–±—ä–µ–∫—Ç—ã –∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∏—Ö —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏ –ø—É–±–ª–∏–∫—É–µ—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, —á–µ—Ä–µ–∑ SSE). –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è ‚Äî –∏–∑–±–µ–≥–∞—Ç—å —Ç—è–∂—ë–ª—ã—Ö I/O –≤–Ω—É—Ç—Ä–∏ –¥–æ–ª–≥–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–æ–º–µ–Ω–Ω–æ–π –ª–æ–≥–∏–∫–∏: –∞–≥–µ–Ω—Ç—ã –∏ —Å–µ—Ä–≤–∏—Å—ã —Å–æ–±–∏—Ä–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –≤–æ –≤—Ä–µ–º—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, —Ñ–∏–∫—Å–∏—Ä—É—é—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è, –∫–æ–º–º–∏—Ç—è—Ç, –∞ –∑–∞—Ç–µ–º –ø–æ–º–µ—â–∞—é—Ç —Å–æ–±—ã—Ç–∏—è –≤ –æ—á–µ—Ä–µ–¥—å –¥–ª—è —Ñ–æ–Ω–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.

–≠—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Å–∏–º—É–ª—è—Ü–∏–∏ –ø—Ä–∏ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö (–Ω–∞–ø—Ä. –º–∞—Å—Å–æ–≤—ã–µ –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –≤–ª–∞–¥–µ–Ω–∏–π).

## ‚öôÔ∏è –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –∏ —Ç–µ—Å—Ç–∏—Ä—É–µ–º–æ—Å—Ç—å

–î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –æ—Å—Ç–∞—Ç–æ—á–Ω—ã—Ö –º–∏–Ω–∏–º–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü –ø—Ä–∏ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–º —Ä–∞–∑–¥–µ–ª–µ) –¥–æ–±–∞–≤–ª–µ–Ω–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ä–∞–Ω–¥–æ–º–∞: –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `IRandomProvider` –∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è `SeedableRandom` –ø–æ–∑–≤–æ–ª—è—é—Ç —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å seed –≤ —Ç–µ—Å—Ç–∞—Ö, —á—Ç–æ–±—ã –ø–æ–≤—Ç–æ—Ä–Ω–æ –ø–æ–ª—É—á–∞—Ç—å –æ–¥–Ω—É –∏ —Ç—É –∂–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è.

## üì° –†–µ–∞–ª—å–Ω–æ–µ –≤—Ä–µ–º—è –∏ –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å

- –°–æ–±—ã—Ç–∏—è –∏ –ø–æ–≥–æ–¥–Ω—ã–µ —Å–Ω–∏–º–∫–∏ –ø—É–±–ª–∏–∫—É—é—Ç—Å—è –Ω–µ —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ `EventStreamService`, –Ω–æ –∏ —Ç—Ä–∞–Ω—Å–ª–∏—Ä—É—é—Ç—Å—è –ø–æ SignalR-—Ö–∞–±—É `/hubs/events` (–∞–≤—Ç–æ—Ä–µ–∫–æ–Ω–Ω–µ–∫—Ç –≤–∫–ª—é—á—ë–Ω, –º–æ–∫-—Å—Ç—Ä–∏–º –≤–∫–ª—é—á–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–º –æ–±—Ä—ã–≤–µ –∫–∞–Ω–∞–ª–∞ –∏ –≤—ã–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è). SSE-—ç–Ω–¥–æ–∏–Ω—Ç—ã /api/events/stream –∏ /api/weather/stream —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏.
- TickWorker –∏ –∞–≥–µ–Ω—Ç—ã –æ–±—ë—Ä–Ω—É—Ç—ã OpenTelemetry `ActivitySource` (`Imperium.TickWorker`) –∏ —Ñ–∏–∫—Å–∏—Ä—É—é—Ç —Å—Ç–∞—Ç—É—Å—ã (`tick.started/completed/errors`, `agents.<Name>.success|timeouts|errors`), —á—Ç–æ —É–ø—Ä–æ—â–∞–µ—Ç —Ç—Ä–∞—Å—Å–∏—Ä–æ–≤–∫—É –¥–æ–ª–≥–∏—Ö —Ñ–∞–∑.
- LLM-–≤—ã–∑–æ–≤—ã –∏–¥—É—Ç —á–µ—Ä–µ–∑ –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä `LlmMetricsDecorator`, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–∑–¥–∞—ë—Ç Activity `Imperium.Llm`, —Å—á–∏—Ç–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫–∏ (`llm.requests/success/errors/canceled`) –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—É `imperium_llm_duration_ms`.
- Prometheus-—Å–∫—Ä–µ–π–ø –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ `/metrics`; –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É—é—Ç—Å—è –≥–∏—Å—Ç–æ–≥—Ä–∞–º–º—ã –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç–∏–∫–æ–≤ (`imperium_tick_duration_ms`) –∏ –∞–≥–µ–Ω—Ç–æ–≤ (`imperium_agent_duration_ms`), —Å—á—ë—Ç—á–∏–∫–∏ —ç–∫–æ–Ω–æ–º–∏–∫–∏ (`imperium_economy.orders.*`), —Ä–µ–∞–∫—Ü–∏–∏ NPC (`npc.replies`), –ª–æ–≥–∏—Å—Ç–∏–∫–∞ (`logistics.jobs.*`) –∏ –Ω–æ–≤—ã–µ LLM-—Å—á—ë—Ç—á–∏–∫–∏ (`imperium_llm_*`).
- REST-—Å—Ä–µ–∑ `/api/metrics/ticks` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ç–∏–∫–æ–≤ (–∫–æ–ª—å—Ü–µ–≤–æ–π –±—É—Ñ–µ—Ä –Ω–∞ ~120 –∑–Ω–∞—á–µ–Ω–∏–π) –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ñ—Ä–æ–Ω—Ç—ç–Ω–¥–æ–º –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å–ø–∞—Ä–∫–ª–∞–π–Ω–∞ –≤ —Å–∞–π–¥–±–∞—Ä–µ.
- WorldTime: `TimeAI` —Ç–µ–ø–µ—Ä—å –ø—É–±–ª–∏–∫—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã—á–∏—Å–ª—è–µ–º—ã–µ –ø–æ–ª—è ‚Äî `month` –∏ `dayOfMonth` –≤ —Å–æ–±—ã—Ç–∏–∏ `time_tick`.
- –ù–æ–≤—ã–µ Dev endpoints: `POST /api/dev/tick-now?advanceTime=true` (–≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∞–≥–µ–Ω—Ç—ã –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—å TimeAI) –∏ `POST /api/dev/tick-time` (–ø—Ä–æ–≥–æ–Ω —Ç–æ–ª—å–∫–æ TimeAI). –û—Ç–≤–µ—Ç—ã —Å–æ–¥–µ—Ä–∂–∞—Ç `worldTime` –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ —Ç–µ—Å—Ç–æ–≤ –∏ UI.
- –°–æ–±—ã—Ç–∏—è –≤—Ä–µ–º–µ–Ω–∏: `time_tick` (–≤–∫–ª—é—á–∞—è `month`/`dayOfMonth`), `day_change`, `month_change`, `year_change` ‚Äî –ø–æ–ª–µ–∑–Ω—ã –¥–ª—è —Å–µ–∑–æ–Ω–Ω—ã—Ö/–∫–∞–ª–µ–Ω–¥–∞—Ä–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤ –∏ UI –≤–∏–¥–∂–µ—Ç–æ–≤.
