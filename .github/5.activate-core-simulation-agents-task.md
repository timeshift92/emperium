
# ‚öôÔ∏è Copilot SWE Task ‚Äî Activate Core Simulation Agents

## üéØ Goal
Enable the **live simulation loop** in Imperium Universe so that the world begins to evolve automatically after creation.  
This task connects and expands the existing agents (`TimeAI`, `SeasonAI`, `EconomyAI`, `NpcAI`) to perform meaningful world updates every 30 seconds.

---

## üß© Architecture Context
Project structure (Aspire-style):
- `Imperium.Api` ‚Äî Minimal API + TickWorker (already implemented)
- `Imperium.Domain` ‚Äî agents and domain models
- `Imperium.Infrastructure` ‚Äî EF Core + SQLite
- `Imperium.Llm` ‚Äî JSON-based LLM client

Already implemented:
‚úÖ `TickWorker` (BackgroundService) ‚Äî runs world ticks every 30s  
‚úÖ `IWorldAgent` interface  
‚úÖ `ILlmClient` and JSON-only LLM prompts  
‚úÖ `SignalR` and SSE event streaming  

Missing: actual logic inside core simulation agents.

---

## üèóÔ∏è Tasks

### 1Ô∏è‚É£ Extend and activate `TimeAI`
File: `src/Imperium.Domain/Agents/TimeAI.cs`

Logic:
- Load current `WorldTime`
- Increment tick (`Tick += 1`)
- Every 2880 ticks ‚Üí advance `Day += 1`
- Every 34560 ticks ‚Üí advance `Year += 1`
- Save changes
- Create a `GameEvent` when the day changes:
  ```text
  "–ü—Ä–æ—à—ë–ª –Ω–æ–≤—ã–π –¥–µ–Ω—å ‚Äî –ì–æ–¥ 1, –î–µ–Ω—å 2"
  ```

---

### 2Ô∏è‚É£ Implement `SeasonAI`
File: `src/Imperium.Domain/Agents/SeasonAI.cs`

Logic:
- Read latest `SeasonState` and `WeatherSnapshot`
- Based on `WorldTime.Day`, switch between `spring`, `summer`, `autumn`, `winter`
- Adjust temperature ¬±3¬∞C and precipitation randomly
- Create a `WeatherSnapshot` record each tick
- If the season changes ‚Üí create a `GameEvent`:
  ```text
  "–ù–∞—á–∞–ª–∞—Å—å –ª–µ—Ç–Ω—è—è –∂–∞—Ä–∞ (+3¬∞C)"
  ```

---

### 3Ô∏è‚É£ Implement `EconomyAI`
File: `src/Imperium.Domain/Agents/EconomyAI.cs`

Logic:
- Load last `EconomySnapshot`
- Modify prices slightly (¬±5%) based on season and resource demand
- Update taxes and total treasury in `Location`
- Add random market events (grain shortage, fish surplus, etc.)
- Create a `GameEvent` like:
  ```text
  "–¶–µ–Ω—ã –Ω–∞ –∑–µ—Ä–Ω–æ –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ 5% –∏–∑-–∑–∞ –∑–∞—Å—É—Ö–∏."
  ```
- Save all changes

---

### 4Ô∏è‚É£ Extend `NpcAI`
File: `src/Imperium.Domain/Agents/NpcAI.cs`

Logic:
- Select a few random NPCs (`Character` entries)
- For each, call LLM (`ILlmClient`) with a JSON prompt describing daily life:
  ```json
  { "name": "–§–∏–ª–æ–º–∞—Ö", "location": "–°–∏—Ä–∞–∫—É–∑—ã", "mood": "normal", "situation": "–Ω–æ–≤—ã–π –¥–µ–Ω—å" }
  ```
- Parse response `{ "action": "–ø–æ—Å–µ—Ç–∏–ª —Ä—ã–Ω–æ–∫", "emotion": "—Ä–∞–¥–æ—Å—Ç—å" }`
- Create `GameEvent` entries:
  ```text
  "–§–∏–ª–æ–º–∞—Ö –ø–æ—Å–µ—Ç–∏–ª —Ä—ã–Ω–æ–∫ (—Ä–∞–¥–æ—Å—Ç—å)"
  ```

---

### 5Ô∏è‚É£ Register agents in dependency container
File: `src/Imperium.Api/Program.cs` or `ServiceDefaults.cs`

Add:
```csharp
builder.Services.AddSingleton<IWorldAgent, TimeAI>();
builder.Services.AddSingleton<IWorldAgent, SeasonAI>();
builder.Services.AddSingleton<IWorldAgent, EconomyAI>();
builder.Services.AddSingleton<IWorldAgent, NpcAI>();
```

---

### 6Ô∏è‚É£ Verify event streaming
Ensure `EventDispatcher` or `EventStreamService` publishes `GameEvent` updates to SignalR hub `/hubs/events`  
and fallback SSE `/api/events/stream`.

Each new tick should broadcast JSON payload:
```json
{
  "type": "tick",
  "worldTime": { "year": 1, "day": 2, "tick": 34560 },
  "summary": "–ü—Ä–æ—à—ë–ª –Ω–æ–≤—ã–π –¥–µ–Ω—å ‚Äî –ì–æ–¥ 1, –î–µ–Ω—å 2"
}
```

---

## ‚úÖ Acceptance Criteria
- [ ] `TickWorker` triggers all agents sequentially every 30s.
- [ ] `TimeAI` updates time and generates daily events.
- [ ] `SeasonAI` changes seasons and creates weather snapshots.
- [ ] `EconomyAI` adjusts prices and produces market events.
- [ ] `NpcAI` uses LLM to generate NPC actions.
- [ ] All events appear in `GameEvent` table and stream to `/hubs/events` or `/api/events/stream`.
- [ ] Console output shows agent logs, e.g.:
  ```
  [TimeAI] –ù–æ–≤—ã–π –¥–µ–Ω—å ‚Äî –ì–æ–¥ 1, –î–µ–Ω—å 2
  [SeasonAI] –ü–æ–≥–æ–¥–∞: 25¬∞C, —è—Å–Ω–æ–µ –Ω–µ–±–æ
  [EconomyAI] –¶–µ–Ω–∞ –∑–µ—Ä–Ω–∞ –≤—ã—Ä–æ—Å–ª–∞ –Ω–∞ 3%
  [NpcAI] –ê—Ä—Ö–æ–Ω—Ç –§–∏–ª–æ–º–∞—Ö –ø–æ—Å–µ—Ç–∏–ª —Ä—ã–Ω–æ–∫
  ```

---

## üí° Optional (future)
- Add `MetricsService.RecordAgentDuration(agentName, durationMs)` for Prometheus metrics.
- Add `HistoryAI` to summarize daily/annual events into `WorldChronicle`.
- Implement `FaithAI` and `KnowledgeAI` later for culture and discoveries.

---

## üßæ References
- `Imperium.Api/TickWorker.cs`
- `Imperium.Domain/Agents/*`
- `Imperium.Domain.Models.WorldTime`
- `Imperium.Domain.Models.GameEvent`
- `Imperium.Infrastructure/AppDbContext.cs`
- `Imperium.Api/EventStreamService.cs`
