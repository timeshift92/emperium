
# üß¨ Copilot SWE Task ‚Äî NPC Population & Lifecycle System

## üéØ Goal
Introduce a **living NPC ecosystem** in Imperium Universe:  
characters should be born, age, die, and pass on traits, talents, and knowledge to their descendants.  
This connects `NpcAI`, `FamilyAI`, and `GeneticAI` into a unified demographic system.

---

## üß© Architecture Context
Project structure (Aspire-style):
- `Imperium.Domain` ‚Äî domain models, agents, logic
- `Imperium.Infrastructure` ‚Äî EF Core + SQLite
- `Imperium.Api` ‚Äî background TickWorker, event system
- `Imperium.Llm` ‚Äî JSON LLM client

Existing:
‚úÖ `Character`, `NpcEssence`, `Family` models  
‚úÖ `NpcAI`, `GeneticAI`, `RelationshipAI` (stubs exist)  
‚úÖ `TickWorker` executes agents sequentially every 30s  

This task adds **life cycle mechanics**: birth, age progression, death, inheritance.

---

## üèóÔ∏è Tasks

### 1Ô∏è‚É£ Extend `Character` model
File: `src/Imperium.Domain/Models/Character.cs`

Add fields:
```csharp
public int Age { get; set; }
public bool IsAlive { get; set; } = true;
public Guid? MotherId { get; set; }
public Guid? FatherId { get; set; }
public DateTime BornAt { get; set; }
public DateTime? DiedAt { get; set; }
public string? CauseOfDeath { get; set; }
```
And relationships to `Family` / `NpcEssence`.

---

### 2Ô∏è‚É£ Create `FamilyAI`
File: `src/Imperium.Domain/Agents/FamilyAI.cs`

Responsibilities:
- Handle NPC reproduction, parent-child linking.
- Every few days (e.g., every 2880 * 10 ticks):
  - Randomly select couples of same `Faction` or `Location`.
  - 10‚Äì20% chance to spawn a child if population < MaxNpcCount.
  - Create `Character` child:
    ```csharp
    var child = new Character {
        Name = NpcNameGenerator.Generate(),
        Gender = random.NextDouble() > 0.5 ? "male" : "female",
        Age = 0,
        BornAt = DateTime.UtcNow,
        LocationId = parent.LocationId,
        FactionId = parent.FactionId,
        IsAlive = true
    };
    ```
  - Add reference in `Family` table.

- Emit `GameEvent`:
  ```text
  –†–æ–¥–∏–ª—Å—è –Ω–æ–≤—ã–π —Ä–µ–±—ë–Ω–æ–∫ –≤ —Å–µ–º—å–µ –ê—Ä—Ö–æ–Ω–∞ –§–∏–ª–æ–º–∞—Ö–∞.
  ```

---

### 3Ô∏è‚É£ Create `GeneticAI`
File: `src/Imperium.Domain/Agents/GeneticAI.cs`

Responsibilities:
- Each newborn inherits averaged traits from parents (`NpcEssence`):
  - Strength, Intelligence, Charisma, Vitality, Luck.
  - Apply ¬±10% mutation chance.
- Example logic:
  ```csharp
  essence.Strength = (father.Strength + mother.Strength)/2 * (1 + mutation);
  ```
- Create new `NpcEssence` entry for the child.
- Emit `GameEvent`:  
  ```text
  –ú–ª–∞–¥–µ–Ω–µ—Ü —É–Ω–∞—Å–ª–µ–¥–æ–≤–∞–ª –∂–∏–≤–æ—Å—Ç—å —É–º–∞ –æ—Ç –º–∞—Ç–µ—Ä–∏ –∏ —Å–∏–ª—É –æ—Ç –æ—Ç—Ü–∞.
  ```

---

### 4Ô∏è‚É£ Extend `NpcAI` for aging & mortality
File: `src/Imperium.Domain/Agents/NpcAI.cs`

Logic per tick:
- Increment `Age` for all `IsAlive` characters.
- If `Age > 70 + random(0,10)` ‚Üí mark as dead.
- Set `DiedAt = DateTime.UtcNow`, `IsAlive = false`.
- Add `GameEvent`:
  ```text
  –°—Ç–∞—Ä–µ–π—à–∏–Ω–∞ –î—Ä–∞–∫–æ–Ω —É–º–µ—Ä –≤ –≤–æ–∑—Ä–∞—Å—Ç–µ 74 –ª–µ—Ç.
  ```

- Once dead, exclude NPC from LLM actions.

---

### 5Ô∏è‚É£ Add config control
File: `appsettings.json`
```json
"World": {
  "InitialNpcCount": 50,
  "MaxNpcCount": 2000,
  "NpcBirthRate": 0.15,
  "NpcMortalityBase": 0.005
}
```

Use `IOptions<WorldConfig>` to access these in `FamilyAI` and `NpcAI`.

---

### 6Ô∏è‚É£ Update TickWorker registration
File: `src/Imperium.Api/Program.cs`

Add:
```csharp
builder.Services.AddSingleton<IWorldAgent, FamilyAI>();
builder.Services.AddSingleton<IWorldAgent, GeneticAI>();
```

Ensure tick order:
```
... ‚Üí NpcAI ‚Üí FamilyAI ‚Üí GeneticAI ‚Üí EventDispatcher
```

---

## ‚úÖ Acceptance Criteria
- [ ] `Character` model extended with lifecycle fields.
- [ ] `FamilyAI` creates new NPCs based on population and chance.
- [ ] `GeneticAI` assigns inherited traits and mutations.
- [ ] `NpcAI` handles aging and mortality.
- [ ] Death and birth events recorded in `GameEvent`.
- [ ] World population remains stable (oscillates around ~50‚Äì2000).
- [ ] No data duplication or runaway population growth.

---

## üí° Optional (future)
- Add `HeirAssignmentService` to transfer property/knowledge from parents to children.
- Add `GraveyardAI` or `HistoryAI` integration for obituaries.
- Track bloodlines and noble houses through `FamilyLineage` model.

---

## üßæ References
- `Imperium.Domain/Models/Character.cs`
- `Imperium.Domain/Models/NpcEssence.cs`
- `Imperium.Domain/Agents/NpcAI.cs`
- `Imperium.Domain/Agents/FamilyAI.cs`
- `Imperium.Domain/Agents/GeneticAI.cs`
- `Imperium.Infrastructure/AppDbContext.cs`
- `Imperium.Api/TickWorker.cs`
