
# ü´Ç Copilot SWE Task ‚Äî Relationship & Reputation AI

## üéØ Goal
Develop **RelationshipAI** and **ReputationAI** systems to simulate social interactions, friendships, rivalries, and reputational effects among NPCs in Imperium Universe.  
This enables emotional, political, and social depth ‚Äî characters now *remember*, *react*, and *influence* one another.

---

## üß© Architecture Context
Project structure (Aspire-style):
- `Imperium.Domain` ‚Äî models, agents, relationships
- `Imperium.Infrastructure` ‚Äî EF Core, data setup
- `Imperium.Api` ‚Äî TickWorker, event streaming
- `Imperium.Llm` ‚Äî structured JSON prompts

Depends on existing systems:
- ‚úÖ `NpcAI` (autonomous actions)
- ‚úÖ `NpcEssence` and `Character` models
- ‚úÖ `GameEvent` recording and streaming
- ‚úÖ `WorldTime`, `Weather`, and `Economy` context

---

## üß† Concept Overview

Every NPC maintains **social bonds** (`Relationship`) and **social standing** (`Reputation`):

| Concept | Description |
|----------|--------------|
| `Relationship` | Direct link between two NPCs ‚Äî friendship, rivalry, love, debt |
| `Reputation` | Global/public measure of respect, fear, fame |
| `Mood` & `Memory` | Affect decisions and emotions |

Relationships influence NPC decisions ‚Äî friendly NPCs may trade or help, rivals may sabotage or challenge.

---

## üèóÔ∏è Tasks

### 1Ô∏è‚É£ Create Relationship Models
File: `src/Imperium.Domain/Models/Relationship.cs`
```csharp
public class Relationship
{
    public Guid Id { get; set; }
    public Guid SourceId { get; set; }
    public Guid TargetId { get; set; }
    public string Type { get; set; } = "neutral"; // friendship, rivalry, love, debt, kinship
    public double Strength { get; set; } = 0.0;   // -1..1 range
    public DateTime LastInteraction { get; set; }
}
```
Also create `Reputation` model:
```csharp
public class Reputation
{
    public Guid Id { get; set; }
    public Guid CharacterId { get; set; }
    public double Value { get; set; } = 0.0; // -1..1 range
    public string? Reason { get; set; }
    public DateTime UpdatedAt { get; set; } = DateTime.UtcNow;
}
```

---

### 2Ô∏è‚É£ Implement RelationshipAI
File: `src/Imperium.Domain/Agents/RelationshipAI.cs`

#### Logic
Each tick:
1. Select 10‚Äì20 random alive NPC pairs (same `LocationId`).
2. Evaluate existing `Relationship` or create new one.
3. Use simple probability model:
   - Shared Faction ‚Üí +0.05 friendship
   - Trade success ‚Üí +0.1
   - Competing goals ‚Üí -0.1 rivalry
4. Clamp strength to [-1, 1].
5. Create `GameEvent` summarizing interaction:
   ```text
   –§–∏–ª–æ–º–∞—Ö –ø–æ–±–µ—Å–µ–¥–æ–≤–∞–ª —Å –ò–ª–∞—Ä–∏–µ–π ‚Äî –¥—Ä—É–∂–±–∞ —É–∫—Ä–µ–ø–∏–ª–∞—Å—å.
   ```
6. Occasionally (5%) spawn social events like feasts, duels, or festivals.

---

### 3Ô∏è‚É£ Implement ReputationAI
File: `src/Imperium.Domain/Agents/ReputationAI.cs`

#### Logic
1. Once per day, aggregate NPC actions (`GameEvent`) that mention them.
2. For each `Character`:
   - If action includes ‚Äúhelped‚Äù, ‚Äúcreated‚Äù, ‚Äúprotected‚Äù ‚Üí +0.02
   - If ‚Äústole‚Äù, ‚Äúkilled‚Äù, ‚Äúbetrayed‚Äù ‚Üí -0.05
3. Update `Reputation.Value` (range -1 to +1).
4. Create summary `GameEvent`:
   ```text
   –†–µ–ø—É—Ç–∞—Ü–∏—è –ê—Ä—Ö–æ–Ω—Ç–∞ –§–∏–ª–æ–º–∞—Ö–∞ –≤—ã—Ä–æ—Å–ª–∞ –ø–æ—Å–ª–µ —â–µ–¥—Ä–æ–≥–æ –ø–æ–∂–µ—Ä—Ç–≤–æ–≤–∞–Ω–∏—è —Ö—Ä–∞–º—É.
   ```

---

### 4Ô∏è‚É£ Integrate into Tick Loop
Ensure `RelationshipAI` and `ReputationAI` run after `NpcAI`:

```
TimeAI ‚Üí SeasonAI ‚Üí EconomyAI ‚Üí NpcAI ‚Üí RelationshipAI ‚Üí ReputationAI ‚Üí EventDispatcher
```

Add DI registration:
```csharp
builder.Services.AddSingleton<IWorldAgent, RelationshipAI>();
builder.Services.AddSingleton<IWorldAgent, ReputationAI>();
```

---

### 5Ô∏è‚É£ LLM Integration (Optional Enhancement)
If `ILlmClient` is available, allow nuanced emotional dialogue generation:
```json
{
  "npc_a": "–§–∏–ª–æ–º–∞—Ö",
  "npc_b": "–ò–ª–∞—Ä–∏—è",
  "relationship": "friendship",
  "strength": 0.7,
  "context": "–≤–µ—á–µ—Ä —É —Ö—Ä–∞–º–∞"
}
```
‚Üí  
```json
{
  "interaction": "–ø–æ–±–µ—Å–µ–¥–æ–≤–∞–ª –æ –≤–µ—Ä–µ –∏ –ø–æ–¥–µ–ª–∏–ª—Å—è –∏—Å—Ç–æ—Ä–∏—è–º–∏",
  "emotion": "–¥–æ–≤–µ—Ä–∏–µ"
}
```

---

## ‚úÖ Acceptance Criteria
- [ ] Relationship and Reputation tables exist and are populated.
- [ ] NPCs form, strengthen, or weaken social bonds dynamically.
- [ ] GameEvents reflect relationships (‚Äú–¥—Ä—É–∂–±–∞‚Äù, ‚Äú–≤—Ä–∞–∂–¥–∞‚Äù, ‚Äú–ª—é–±–æ–≤—å‚Äù, ‚Äú–¥–æ–ª–≥‚Äù).
- [ ] Reputation evolves from NPC actions.
- [ ] TickWorker includes `RelationshipAI` and `ReputationAI` in loop.
- [ ] Console/log output includes:
  ```
  [RelationshipAI] –î—Ä—É–∂–±–∞ –º–µ–∂–¥—É –§–∏–ª–æ–º–∞—Ö–æ–º –∏ –ò–ª–∞—Ä–∏–µ–π —É—Å–∏–ª–∏–ª–∞—Å—å.
  [ReputationAI] –†–µ–ø—É—Ç–∞—Ü–∏—è –ê—Ä—Ö–æ–Ω—Ç–∞ –§–∏–ª–æ–º–∞—Ö–∞ –ø–æ–≤—ã—Å–∏–ª–∞—Å—å.
  ```

---

## üí° Optional (future)
- Add `SocietyAI` to simulate guilds, cults, and factions.
- Integrate with `FaithAI` and `CultureAI` for collective rituals and myths.
- Add `NpcMemory` model to store remembered interactions.

---

## üßæ References
- `Imperium.Domain/Agents/NpcAI.cs`
- `Imperium.Domain/Models/Character.cs`
- `Imperium.Domain/Models/NpcEssence.cs`
- `Imperium.Domain/Models/GameEvent.cs`
- `Imperium.Infrastructure/AppDbContext.cs`
- `Imperium.Api/EventStreamService.cs`
