
# ü§ñ Copilot SWE Task ‚Äî NPC Behavior Evolution System

## üéØ Goal
Evolve NPCs from reactive entities into **autonomous agents** that act, feel, and respond dynamically to world context (time, weather, economy, relationships).  
This task upgrades `NpcAI` into a self-driven behavioral system that continuously generates actions and emotions even without external events.

---

## üß© Architecture Context
Project structure (Aspire-style):
- `Imperium.Domain` ‚Äî world agents, domain logic
- `Imperium.Api` ‚Äî TickWorker and live event streaming
- `Imperium.Infrastructure` ‚Äî EF Core + SQLite
- `Imperium.Llm` ‚Äî JSON-only LLM integration

Existing logic:
‚úÖ `NpcAgent` in API handles reply queues (`INpcReplyQueue`) and GameEvent creation  
‚úÖ `EventDispatcher` and SignalR streaming are functional  
‚úÖ `TickWorker` executes agent chain every 30s

We now extend `NpcAI` to **autonomously drive NPC daily behaviors** based on environmental and emotional context.

---

## üß† Behavior Model

### NPC Behavior Inputs
Each tick, `NpcAI` should consider:
| Source | Example influence |
|---------|------------------|
| `WorldTime` | morning ‚Üí work; night ‚Üí rest |
| `WeatherSnapshot` | rain ‚Üí stay indoors |
| `EconomySnapshot` | market boom ‚Üí trading behavior |
| `Relationships` | visit friend, quarrel, romance |
| `Knowledge` | study or invent |
| `Faith` | pray or attend ritual |

### NPC State Variables
Add to `Character` or `NpcEssence`:
```csharp
public string Mood { get; set; } = "neutral";
public string LastAction { get; set; } = "";
public double Energy { get; set; } = 1.0; // 0-1 scale
public double Motivation { get; set; } = 1.0; // drive to act
```

Mood can be `"neutral"`, `"happy"`, `"tired"`, `"angry"`, `"curious"`, `"sad"`, etc.

---

## üèóÔ∏è Tasks

### 1Ô∏è‚É£ Extend `NpcAI`
File: `src/Imperium.Domain/Agents/NpcAI.cs`

Implement behavior tick:
1. Load all alive NPCs (`IsAlive == true`)
2. For each, gather context (time, weather, economy, mood)
3. Use `ILlmClient` to request next action:
   ```json
   {
     "npc_name": "–§–∏–ª–æ–º–∞—Ö",
     "location": "–°–∏—Ä–∞–∫—É–∑—ã",
     "hour": 10,
     "weather": "—è—Å–Ω–æ",
     "economy": "—Å—Ç–∞–±–∏–ª—å–Ω–∞—è",
     "mood": "—Ä–∞–¥–æ—Å—Ç–Ω—ã–π"
   }
   ```
4. Parse JSON reply:
   ```json
   {
     "action": "–ø–æ—à—ë–ª –Ω–∞ —Ä—ã–Ω–æ–∫ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –∞–º—Ñ–æ—Ä—ã",
     "emotion": "—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ",
     "context": "—É—Ç—Ä–æ —è—Å–Ω–æ, —Ç–æ—Ä–≥–æ–≤—ã–π –¥–µ–Ω—å"
   }
   ```
5. Save to DB:
   - Update `Mood`, `LastAction`, `Energy`, `Motivation`
   - Create `GameEvent` with summary text
6. Occasionally (10% chance), modify relationships or reputation

---

### 2Ô∏è‚É£ Add simple daily rhythm
Each NPC‚Äôs motivation/energy changes by time of day:
```csharp
if (worldTime.Hour >= 6 && worldTime.Hour < 12) npc.Energy += 0.1; // morning boost
else if (worldTime.Hour >= 20) npc.Energy -= 0.2; // tired at night
npc.Energy = Math.Clamp(npc.Energy, 0, 1);
```
NPC acts only if `Energy > 0.3` and `Motivation > 0.2`.

---

### 3Ô∏è‚É£ Emotions and feedback
Mood may shift based on weather or social outcomes:
```csharp
if (weather.TempC < 0) npc.Mood = "—É–≥—Ä—é–º—ã–π";
if (event.Type == "trade_success") npc.Mood = "–¥–æ–≤–æ–ª—å–Ω—ã–π";
```
Store these transitions in `GameEvent`:
> ‚Äú–§–∏–ª–æ–º–∞—Ö –ø—Ä–æ–¥–∞–ª –∞–º—Ñ–æ—Ä—ã –∏ —á—É–≤—Å—Ç–≤—É–µ—Ç —É–¥–æ–≤–ª–µ—Ç–≤–æ—Ä–µ–Ω–∏–µ.‚Äù

---

### 4Ô∏è‚É£ Optimize LLM calls
- Limit to 5‚Äì10 NPCs per tick to avoid overload.
- Select subset: active NPCs (high motivation).
- Use streaming or parallel requests if available.

---

### 5Ô∏è‚É£ Integration in TickWorker
Ensure `NpcAI` runs after:
```
TimeAI ‚Üí SeasonAI ‚Üí EconomyAI ‚Üí NpcAI ‚Üí EventDispatcher
```
All events generated by NPCs should flow through `EventDispatcher` and `EventStreamService`.

---

## ‚úÖ Acceptance Criteria
- [ ] NPCs autonomously generate daily actions (market, rest, craft, pray, interact).
- [ ] Each tick produces several NPC events in `GameEvent` table.
- [ ] NPC mood and energy fluctuate naturally with time/weather.
- [ ] Economy and weather influence NPC choices.
- [ ] GameEvent stream shows realistic ‚Äúslice of life‚Äù behavior, e.g.:
  ```
  [NpcAI] –§–∏–ª–æ–º–∞—Ö –ø–æ—à—ë–ª –Ω–∞ —Ä—ã–Ω–æ–∫ –ø—Ä–æ–¥–∞–≤–∞—Ç—å –∞–º—Ñ–æ—Ä—ã.
  [NpcAI] –ò–ª–∞—Ä–∏—è –º–æ–ª–∏—Ç—Å—è –≤ —Ö—Ä–∞–º–µ –ø–æ–¥ –¥–æ–∂–¥—ë–º.
  [NpcAI] –°—Ç–∞—Ä–µ–π—à–∏–Ω–∞ –î—Ä–∞–∫–æ–Ω –æ—Ç–¥—ã—Ö–∞–µ—Ç –ø–æ—Å–ª–µ —Ç—è–∂—ë–ª–æ–≥–æ –¥–Ω—è.
  ```

---

## üí° Optional (future)
- Connect with `SocialAI` and `ReputationAI` for NPC gossip and fame.
- Track daily journals in `NpcMemory` for historical context.
- Allow `NpcAI` to affect economy (trades, production).
- Simulate festivals or collective events triggered by multiple NPCs.

---

## üßæ References
- `Imperium.Api/Services/NpcAgent.cs`
- `Imperium.Domain/Agents/NpcAI.cs`
- `Imperium.Domain/Models/Character.cs`
- `Imperium.Domain/Models/NpcEssence.cs`
- `Imperium.Domain/Models/GameEvent.cs`
- `Imperium.Infrastructure/AppDbContext.cs`
- `Imperium.Api/EventStreamService.cs`
